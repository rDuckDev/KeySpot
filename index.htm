<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<title>KeySpot</title>

	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootswatch@4.0.0/dist/materia/bootstrap.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.5.2/animate.min.css">
</head>
<body>
	<nav class="navbar navbar-dark bg-primary">
		<div class="container">
			<strong class="navbar-brand">
				<i class="fa fa-key fa-lg fa-rotate-270 text-warning"></i>Spot
			</strong>
		</div>
	</nav>

	<main id="KeySpotApp" class="container">
		<spot-form v-on:add="add"></spot-form>
		<div class="card mt-4">
			<div class="card-header">
				<h3 class="m-0">
					<button class="close" data-toggle="modal" data-target="#SpotForm">&plus;</button>
					My spots
				</h3>
			</div>
			<div class="card-body">
				<div class="row">
					<div class="col" v-if="!spots.length">
						<div class="alert alert-warning">
							<span class="mr-2">Add a spot to begin.</span>
							<button class="btn btn-warning" data-toggle="modal" data-target="#SpotForm">&plus;</button>
						</div>
					</div>
					<div class="col-12 col-md-6 col-lg-4 mb-4" v-for="spot in spots">
						<spot-card
							v-bind:spot="spot"
							v-bind:key="spot._id"
							v-on:remove="remove">
						</spot-card>
					</div>
				</div>
			</div>
		</div>
	</main>

	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@webcomponents/webcomponentsjs@1.0.22/webcomponents-lite.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/pouchdb@6.4.1/dist/pouchdb.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/jquery@3.2.1/dist/jquery.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lodash@4.17.4/lodash.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/popper.js@1.12.9/dist/umd/popper.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/js/bootstrap.min.js"></script>
	<script type="text/javascript" src="https://cdn.jsdelivr.net/gh/rDuckDev/CoreJS@0.1.0-alpha/core.js"></script>
	<script type="text/javascript">
		(function () {
			"use strict";

			var DOM = {},
				App = {},
				Bundle = {},
				Components = [];

			Components.push("./component/form.htm");
			Components.push("./component/card.htm");

			var spotDB = new PouchDB("SpotDB");

			function loadData () {
				var self = this;

				spotDB.allDocs({ include_docs: true })
					.then(function (results) {
						_.forEach(results.rows, function (row) {
							var rec = _.cloneDeep(row.doc);

							delete rec._rev;

							self.spots.push(rec);
						});
					});
			}
			function add (spot) {
				var rec = {
					_id: new Date().getTime().toString(),
					uName: spot.uName,
					uLatitude: spot.uLatitude,
					uLongitude: spot.uLongitude,
					uLink: spot.uLink,
					uCode: spot.uCode
				};

				spotDB.put(rec);
				this.spots.push(rec);
			}
			function remove (id) {
				var index = _.findIndex(this.spots, [ "_id", id ]);

				spotDB.get(this.spots[index]._id)
					.then(function (rec) {
						return spotDB.remove(rec);
					});
				this.spots.splice(index, 1);
			}
			function buildApp () {
				new Vue({
					el: "#KeySpotApp",
					data: { spots: [] },
					methods: {
						add: add,
						remove: remove,
						loadData: loadData
					},
					beforeMount: function () { this.loadData() }
				});
			}

			jQuery(document).ready(function () {
				CORE.loadComponents(Components, buildApp);
			});
		} ());
	</script>
</body>
</html>